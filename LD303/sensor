#include <WiFi.h>
#include <HTTPClient.h>
#include <ArduinoJson.h>

// WiFi配置
const char* ssid = "your_wifi_ssid";
const char* password = "your_wifi_password";

// 服务器配置
const char* serverURL = "http://your-pc-ip:5000/data";

// LD303配置
String nodeID = "node_001";
float nodeX = 0.0;  // 节点X坐标
float nodeY = 0.0;  // 节点Y坐标

// 模拟LD303数据读取（实际需要根据LD303的通信协议实现）
struct LD303Data {
  float distance;    // 距离 (米)
  float angle;       // 角度 (度)
  float x;          // 计算出的X坐标
  float y;          // 计算出的Y坐标
  int presence;     // 存在状态
  float confidence; // 置信度
};

void setup() {
  Serial.begin(115200);
  
  // 连接WiFi
  WiFi.begin(ssid, password);
  while (WiFi.status() != WL_CONNECTED) {
    delay(1000);
    Serial.println("Connecting to WiFi...");
  }
  Serial.println("Connected to WiFi");
  
  // 初始化串口与LD303通信（根据实际接口调整）
  Serial1.begin(115200, SERIAL_8N1, 4, 5); // 使用UART1与LD303通信
}

void loop() {
  // 读取LD303数据
  LD303Data sensorData = readLD303Data();
  
  // 发送数据到服务器
  sendSensorData(sensorData);
  
  delay(100); // 100ms采集一次
}

LD303Data readLD303Data() {
  LD303Data data;
  
  // 模拟读取LD303数据（实际需要根据LD303协议解析）
  // 这里使用模拟数据，实际需要从串口读取并解析
  data.distance = random(100, 500) / 100.0; // 1.0-5.0米
  data.angle = random(-60, 60); // -60到60度
  data.presence = random(0, 2); // 0或1
  data.confidence = random(80, 100) / 100.0; // 0.8-1.0
  
  // 计算全局坐标（基于节点位置和相对坐标）
  float rad = data.angle * PI / 180.0;
  data.x = nodeX + data.distance * cos(rad);
  data.y = nodeY + data.distance * sin(rad);
  
  return data;
}

void sendSensorData(LD303Data data) {
  if (WiFi.status() == WL_CONNECTED) {
    HTTPClient http;
    http.begin(serverURL);
    http.addHeader("Content-Type", "application/json");
    
    // 创建JSON数据
    DynamicJsonDocument doc(1024);
    doc["node_id"] = nodeID;
    doc["timestamp"] = millis();
    doc["distance"] = data.distance;
    doc["angle"] = data.angle;
    doc["x"] = data.x;
    doc["y"] = data.y;
    doc["presence"] = data.presence;
    doc["confidence"] = data.confidence;
    doc["node_x"] = nodeX;
    doc["node_y"] = nodeY;
    
    String jsonString;
    serializeJson(doc, jsonString);
    
    int httpResponseCode = http.POST(jsonString);
    
    if (httpResponseCode > 0) {
      String response = http.getString();
      Serial.println("Data sent successfully");
    } else {
      Serial.println("Error sending data");
    }
    
    http.end();
  }
}
